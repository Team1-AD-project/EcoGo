name: EcoGo CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop, 'feature/**' ]

env:
  REGISTRY: ghcr.io
  # Allow overriding instance without code changes (optional).
  EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID || 'i-07e266221fbbd9a10' }}
  AWS_DEPLOY_REGION: ap-southeast-2
  DEPLOY_PORT: 8090
  # Default username for Amazon Linux. Override for Ubuntu: set secret EC2_SSH_USER=ubuntu
  EC2_SSH_USER: ${{ secrets.EC2_SSH_USER || 'ec2-user' }}
  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

permissions:
  contents: read
  packages: write
  security-events: write
  actions: read

# ════════════════════════════════════════════════════════════════════════
#  STAGE 1 — Detect Project Structure
# ════════════════════════════════════════════════════════════════════════
jobs:
  detect-folders:
    runs-on: ubuntu-latest
    name: Detect project folders
    outputs:
      has_java: ${{ steps.detect.outputs.has_java }}
      has_javascript: ${{ steps.detect.outputs.has_javascript }}
      has_python: ${{ steps.detect.outputs.has_python }}
      has_docker: ${{ steps.detect.outputs.has_docker }}
      image_name: ${{ steps.detect.outputs.image_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect project structure
        id: detect
        run: |
          echo "========================================="
          echo "  EcoGo Project Structure Detection"
          echo "========================================="
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT

          if [ -f "pom.xml" ] || [ -f "build.gradle" ]; then
            echo "has_java=true" >> $GITHUB_OUTPUT
            echo "✅ Java project detected"
          else
            echo "has_java=false" >> $GITHUB_OUTPUT
          fi

          if [ -d "src/main/resources/static/js" ] || [ -f "package.json" ]; then
            echo "has_javascript=true" >> $GITHUB_OUTPUT
            echo "✅ JavaScript frontend detected"
          else
            echo "has_javascript=false" >> $GITHUB_OUTPUT
          fi

          if [ -f "requirements.txt" ] || [ -f "setup.py" ] || [ -d "ml" ]; then
            echo "has_python=true" >> $GITHUB_OUTPUT
            echo "✅ Python ML component detected"
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
            echo "⏭️  No Python ML component"
          fi

          if [ -f "Dockerfile" ]; then
            echo "has_docker=true" >> $GITHUB_OUTPUT
            echo "✅ Dockerfile detected"
          else
            echo "has_docker=false" >> $GITHUB_OUTPUT
          fi
          echo "========================================="

# ════════════════════════════════════════════════════════════════════════
#  STAGE 2 — Parallel Quality, Security & Coverage Checks
# ════════════════════════════════════════════════════════════════════════

  # ── Job 2: Unit Tests (Java Backend) + JaCoCo ─────────────────────
  unit-tests-java:
    runs-on: ubuntu-latest
    name: Unit Tests (Java Backend) + JaCoCo
    needs: detect-folders
    if: needs.detect-folders.outputs.has_java == 'true'
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run Unit Tests with JaCoCo Coverage
        run: mvn clean verify jacoco:report
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo

      - name: Upload JaCoCo Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jacoco-coverage-report
          path: target/site/jacoco/
          if-no-files-found: warn

      - name: Coverage Summary
        if: always()
        run: |
          echo "## JaCoCo Coverage Report" >> $GITHUB_STEP_SUMMARY
          if [ -f target/site/jacoco/jacoco.csv ]; then
            echo "Coverage report generated successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "Coverage report not available." >> $GITHUB_STEP_SUMMARY
          fi

  # ── Job 3: Unit Tests (Python ML) + Coverage ──────────────────────
  unit-tests-python:
    runs-on: ubuntu-latest
    name: Unit Tests (Python ML) + Coverage
    needs: detect-folders
    if: needs.detect-folders.outputs.has_python == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Python Tests with Coverage
        run: pytest --cov=. --cov-report=xml --cov-report=html -v || echo "No Python tests found"
        continue-on-error: true

      - name: Upload Python Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-coverage-report
          path: htmlcov/
          if-no-files-found: warn

  # ── Job 4: Lint & Code Quality ─────────────────────────────────────
  lint:
    runs-on: ubuntu-latest
    name: "Lint & Code Quality (Java + Python + React + Thymeleaf + Android)"
    needs: detect-folders
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        if: needs.detect-folders.outputs.has_java == 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run Checkstyle (Java)
        if: needs.detect-folders.outputs.has_java == 'true'
        run: |
          mvn checkstyle:check -DskipTests
          mvn checkstyle:checkstyle -DskipTests

      - name: Run ESLint (JavaScript)
        if: needs.detect-folders.outputs.has_javascript == 'true'
        run: |
          npm init -y > /dev/null 2>&1
          npm install eslint@8 --save-dev
          npx eslint src/main/resources/static/js/ \
            --no-eslintrc \
            --rule '{"no-unused-vars": "warn", "no-undef": "warn", "semi": "warn"}' \
            --env browser --env es2021 \
            || echo "ESLint completed with warnings"
        continue-on-error: true

      - name: Upload Lint Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-reports
          path: |
            target/checkstyle-result.xml
            target/site/checkstyle.html
          if-no-files-found: warn

  # ── Jobs 5-7: SAST (CodeQL) — Java, JavaScript, Python ────────────
  sast-codeql-java:
    runs-on: ubuntu-latest
    name: "SAST (CodeQL) - Java + JavaScript (+ Python if present) (java)"
    needs: detect-folders
    if: needs.detect-folders.outputs.has_java == 'true'
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
      - name: Build Java for CodeQL
        run: mvn clean compile -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:java"

  sast-codeql-javascript:
    runs-on: ubuntu-latest
    name: "SAST (CodeQL) - Java + JavaScript (+ Python if present) (javascript)"
    needs: detect-folders
    if: needs.detect-folders.outputs.has_javascript == 'true'
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

  sast-codeql-python:
    runs-on: ubuntu-latest
    name: "SAST (CodeQL) - Java + JavaScript (+ Python if present) (python)"
    needs: detect-folders
    if: needs.detect-folders.outputs.has_python == 'true'
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

  # ── Job 8: SCA + Secrets + Misconfig (Trivy FS) ───────────────────
  sca-trivy-fs:
    runs-on: ubuntu-latest
    name: SCA + Secrets + Misconfig (Trivy FS)
    needs: detect-folders
    permissions:
      security-events: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy FS Scan (table output)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: table
          scanners: vuln,secret,misconfig

      - name: Run Trivy FS Scan (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy-fs-results.sarif
          scanners: vuln,secret,misconfig
        continue-on-error: true

      - name: Upload Trivy FS Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-fs-results.sarif
        continue-on-error: true

  # ── PRESERVED: SAST Analysis (SpotBugs + OWASP Dependency Check) ──
  sast-legacy:
    runs-on: ubuntu-latest
    name: SAST Analysis (SpotBugs + OWASP)
    needs: detect-folders
    if: needs.detect-folders.outputs.has_java == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Compile Application
        run: mvn clean compile -DskipTests

      - name: Run SpotBugs
        run: mvn spotbugs:spotbugs -DskipTests
        continue-on-error: true

      - name: Run OWASP Dependency Check
        run: mvn dependency-check:check -DskipTests || echo "Dependency check completed with warnings"
        continue-on-error: true

      - name: SAST Summary
        if: always()
        run: echo "SpotBugs + OWASP Dependency Check scans completed."

      - name: Upload SAST Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sast-legacy-reports
          path: |
            target/spotbugsXml.xml
            target/dependency-check-report.html
          if-no-files-found: warn

# ════════════════════════════════════════════════════════════════════════
#  STAGE 3 — CI Metrics + SonarQube
# ════════════════════════════════════════════════════════════════════════

  ci-metrics:
    runs-on: ubuntu-latest
    name: CI Metrics Summary (JSON)
    needs:
      - unit-tests-java
      - unit-tests-python
      - lint
      - sast-codeql-java
      - sast-codeql-javascript
      - sast-codeql-python
      - sca-trivy-fs
      - sast-legacy
    if: always()
    steps:
      - name: Collect CI Metrics
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          cat > ci-metrics.json << EOF
          {
            "pipeline_run": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "triggered_by": "${{ github.actor }}",
            "event": "${{ github.event_name }}",
            "timestamp": "${TIMESTAMP}",
            "jobs": {
              "unit_tests_java": "${{ needs.unit-tests-java.result }}",
              "unit_tests_python": "${{ needs.unit-tests-python.result }}",
              "lint": "${{ needs.lint.result }}",
              "sast_codeql_java": "${{ needs.sast-codeql-java.result }}",
              "sast_codeql_javascript": "${{ needs.sast-codeql-javascript.result }}",
              "sast_codeql_python": "${{ needs.sast-codeql-python.result }}",
              "sca_trivy_fs": "${{ needs.sca-trivy-fs.result }}",
              "sast_spotbugs_owasp": "${{ needs.sast-legacy.result }}"
            }
          }
          EOF

          echo "## CI Metrics Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (Java) | \`${{ needs.unit-tests-java.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (Python) | \`${{ needs.unit-tests-python.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Code Quality | \`${{ needs.lint.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST CodeQL (Java) | \`${{ needs.sast-codeql-java.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST CodeQL (JS) | \`${{ needs.sast-codeql-javascript.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST CodeQL (Python) | \`${{ needs.sast-codeql-python.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SCA Trivy FS | \`${{ needs.sca-trivy-fs.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SpotBugs + OWASP | \`${{ needs.sast-legacy.result }}\` |" >> $GITHUB_STEP_SUMMARY

      - name: Upload CI Metrics
        uses: actions/upload-artifact@v4
        with:
          name: ci-metrics
          path: ci-metrics.json

  # ── PRESERVED: SonarQube Analysis ──────────────────────────────────
  sonarqube:
    runs-on: ubuntu-latest
    name: SonarQube Analysis
    needs: [unit-tests-java, ci-metrics]
    if: |
      always() &&
      (github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository)
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check SonarQube Configuration
        run: |
          if [ -f ".github/scripts/check-sonar-config.sh" ]; then
            chmod +x .github/scripts/check-sonar-config.sh
            ./.github/scripts/check-sonar-config.sh || true
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: SonarQube Scan
        if: env.SONAR_TOKEN != ''
        run: |
          if [[ "${{ env.SONAR_HOST_URL }}" == *"sonarcloud.io"* ]]; then
            echo "Using SonarCloud - adding organization parameter"
            mvn clean verify sonar:sonar \
              -Dsonar.projectKey=Team1-AD-project_EcoGo \
              -Dsonar.organization=team1-ad-project \
              -Dsonar.sources=src/main \
              -Dsonar.tests=src/test \
              -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
              -Dsonar.login=${{ env.SONAR_TOKEN }}
          else
            echo "Using self-hosted SonarQube"
            mvn clean verify sonar:sonar \
              -Dsonar.projectKey=Team1-AD-project_EcoGo \
              -Dsonar.sources=src/main \
              -Dsonar.tests=src/test \
              -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
              -Dsonar.login=${{ env.SONAR_TOKEN }}
          fi
        continue-on-error: true
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo

      - name: SonarQube Not Configured
        if: env.SONAR_TOKEN == ''
        run: echo "WARNING - SonarQube token not configured. Skipping. See .github/SECRETS-TEMPLATE.md"

# ════════════════════════════════════════════════════════════════════════
#  STAGE 4 — Integration, Functional & Performance Tests (pre-deploy)
# ════════════════════════════════════════════════════════════════════════

  # ── Job 10: Integration Tests (Compose + Schemathesis) ─────────────
  integration-tests:
    runs-on: ubuntu-latest
    name: "Integration Tests (Compose + Schemathesis + optional Playwright)"
    needs: ci-metrics
    if: "!cancelled()"
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run Integration Tests (Maven Verify)
        run: mvn clean verify -Dcheckstyle.skip=true -Dspotbugs.skip=true
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo

      - name: Build and Start App for API Testing
        run: |
          mvn clean package -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true
          nohup java -jar target/EcoGo-*.jar > app.log 2>&1 &
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then
              echo "Application is ready!"
              break
            fi
            echo "Waiting for application... ($i/30)"
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090

      - name: Run Schemathesis API Fuzz Tests
        run: |
          pip install schemathesis
          schemathesis run http://localhost:8090/v3/api-docs \
            --checks all --max-response-time=5000 \
            2>/dev/null || {
            echo "No OpenAPI spec. Running basic API tests..."
            curl -sf http://localhost:8090/actuator/health | python3 -m json.tool
            curl -sf http://localhost:8090/actuator/info || true
            curl -sf http://localhost:8090/actuator/metrics || true
            echo "Basic API endpoint tests passed."
          }
        continue-on-error: true

      - name: Upload Integration Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            target/surefire-reports/
            target/failsafe-reports/
            app.log
          if-no-files-found: warn

  # ── Job 11: Selenium Functional Test ───────────────────────────────
  selenium-tests:
    runs-on: ubuntu-latest
    name: Selenium Functional Test (Pre-Load Validation)
    needs: ci-metrics
    if: "!cancelled()"
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build and Start Application
        run: |
          mvn clean package -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true
          nohup java -jar target/EcoGo-*.jar > app.log 2>&1 &
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then
              echo "Application ready for Selenium tests!"
              break
            fi
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Run Selenium Functional Tests
        run: |
          pip install selenium requests
          python3 << 'SELENIUM_SCRIPT'
          import time, requests
          from selenium import webdriver
          from selenium.webdriver.chrome.options import Options
          from selenium.webdriver.common.by import By

          BASE_URL = "http://localhost:8090"
          passed = failed = 0

          def test(name, func):
              global passed, failed
              try:
                  func()
                  print(f"  PASS: {name}")
                  passed += 1
              except Exception as e:
                  print(f"  FAIL: {name} - {e}")
                  failed += 1

          print("=" * 50)
          print("  Selenium Functional Tests (Pre-Load)")
          print("=" * 50)

          print("\n--- HTTP Pre-Load Validation ---")
          test("Health returns 200",
               lambda: requests.get(f"{BASE_URL}/actuator/health").status_code == 200 or (_ for _ in ()).throw(Exception("failed")))

          print("\n--- Selenium Browser Tests ---")
          opts = Options()
          for arg in ["--headless","--no-sandbox","--disable-dev-shm-usage","--disable-gpu"]:
              opts.add_argument(arg)

          driver = webdriver.Chrome(options=opts)
          try:
              test("Login page loads", lambda: (
                  driver.get(f"{BASE_URL}/login"),
                  time.sleep(2),
                  driver.find_element(By.TAG_NAME, "body")
              ))
              test("Health via browser", lambda: (
                  driver.get(f"{BASE_URL}/actuator/health"),
                  time.sleep(1),
                  "UP" in driver.find_element(By.TAG_NAME, "body").text or True
              ))
              test("Main page loads", lambda: (
                  driver.get(BASE_URL),
                  time.sleep(2),
                  len(driver.page_source) > 100 or (_ for _ in ()).throw(Exception("empty page"))
              ))
          finally:
              driver.quit()

          print(f"\nResults: {passed} passed, {failed} failed")
          SELENIUM_SCRIPT
        continue-on-error: true

      - name: Upload Selenium Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: selenium-results
          path: app.log
          if-no-files-found: warn

  # ── Job 12: Load & Performance Testing (JMeter) ───────────────────
  jmeter-tests:
    runs-on: ubuntu-latest
    name: Load & Performance Testing (JMeter)
    needs: ci-metrics
    if: "!cancelled()"
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build and Start Application
        run: |
          mvn clean package -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true
          nohup java -jar target/EcoGo-*.jar > app.log 2>&1 &
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then
              echo "Application ready for load testing!"
              break
            fi
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090

      - name: Run JMeter Load Tests
        run: |
          docker run --network="host" \
            -v $(pwd)/performance-tests:/tests \
            justb4/jmeter \
            -n -t /tests/load-test.jmx \
            -l /tests/results.jtl \
            -e -o /tests/report

      - name: Upload JMeter Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jmeter-report
          path: |
            performance-tests/report/
            performance-tests/results.jtl
          if-no-files-found: warn

# ════════════════════════════════════════════════════════════════════════
#  STAGE 5 — Build & Push Docker Image + Container Scan
# ════════════════════════════════════════════════════════════════════════

  build-push:
    runs-on: ubuntu-latest
    name: Build & Push Docker Images (main)
    needs: [integration-tests, selenium-tests, jmeter-tests]
    if: |
      !cancelled() &&
      needs.integration-tests.result == 'success'
    permissions:
      packages: write
      contents: read
    outputs:
      image: ${{ steps.image-ref.outputs.image }}
      image_latest: ${{ steps.image-ref.outputs.image_latest }}
    steps:
      - uses: actions/checkout@v4

      - name: Compute image references
        id: image-ref
        run: |
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "image=${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "image_latest=${{ env.REGISTRY }}/${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.image-ref.outputs.image }}
            ${{ steps.image-ref.outputs.image_latest }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image Push Summary
        run: |
          echo "## Docker Image Published" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA tag:** \`${{ steps.image-ref.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest tag:** \`${{ steps.image-ref.outputs.image_latest }}\`" >> $GITHUB_STEP_SUMMARY

  container-scan:
    runs-on: ubuntu-latest
    name: Container Image Scan (Trivy) - main
    needs: build-push
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Built Image
        run: docker pull ${{ needs.build-push.outputs.image }}

      - name: Trivy Container Scan (table)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-push.outputs.image }}
          format: table
          severity: CRITICAL,HIGH

      - name: Trivy Container Scan (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-push.outputs.image }}
          format: sarif
          output: trivy-container-results.sarif
          severity: CRITICAL,HIGH
        continue-on-error: true

      - name: Upload Trivy Container Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-container-results.sarif
          category: container-scan
        continue-on-error: true

# ════════════════════════════════════════════════════════════════════════
#  STAGE 6 — Advanced Security (IAST / k6 / DAST)
# ════════════════════════════════════════════════════════════════════════

  iast-otel:
    runs-on: ubuntu-latest
    name: "IAST (OpenTelemetry runtime \u2013 open source)"
    needs: container-scan
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Download OpenTelemetry Java Agent
        run: |
          curl -L -o opentelemetry-javaagent.jar \
            https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar
          echo "OpenTelemetry Java Agent downloaded"

      - name: Build Application
        run: mvn clean package -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true

      - name: Start App with OTEL Agent (IAST mode)
        run: |
          export OTEL_SERVICE_NAME=ecogo
          export OTEL_TRACES_EXPORTER=logging
          export OTEL_METRICS_EXPORTER=logging
          export OTEL_LOGS_EXPORTER=logging
          nohup java -javaagent:opentelemetry-javaagent.jar \
            -jar target/EcoGo-*.jar > iast-app.log 2>&1 &
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then
              echo "App with OTEL agent is ready!"
              break
            fi
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090

      - name: Exercise Application (generate runtime traces)
        run: |
          for ep in /actuator/health /actuator/info /actuator/metrics /login /api/users /api/activities /api/leaderboard; do
            echo "  Testing: ${ep}"
            curl -s -o /dev/null -w "  -> HTTP %{http_code}\n" http://localhost:8090${ep} || true
          done
          sleep 5

      - name: Collect IAST Results
        if: always()
        run: |
          echo "## IAST (OpenTelemetry) Analysis" >> $GITHUB_STEP_SUMMARY
          if [ -f iast-app.log ]; then
            ERRORS=$(grep -c "ERROR" iast-app.log 2>/dev/null || echo "0")
            WARNINGS=$(grep -c "WARN" iast-app.log 2>/dev/null || echo "0")
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Errors | ${ERRORS} |" >> $GITHUB_STEP_SUMMARY
            echo "| Warnings | ${WARNINGS} |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload IAST Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: iast-otel-results
          path: iast-app.log
          if-no-files-found: warn

  k6-performance:
    runs-on: ubuntu-latest
    name: Performance (k6) - optional
    needs: container-scan
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Build and Start Application
        run: |
          mvn clean package -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true
          nohup java -jar target/EcoGo-*.jar > app.log 2>&1 &
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then
              echo "Application ready for k6!"
              break
            fi
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090
      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring \
            --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 \
            --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | \
            sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update && sudo apt-get install k6 -y
      - name: Run k6 Performance Tests
        run: k6 run k6/load-test.js --summary-export=k6-summary.json
        continue-on-error: true
      - name: Upload k6 Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-performance-results
          path: k6-summary.json
          if-no-files-found: warn

  dast-zap:
    runs-on: ubuntu-latest
    name: DAST (OWASP ZAP) - optional
    needs: container-scan
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Build and Start Application
        run: |
          mvn clean package -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true
          nohup java -jar target/EcoGo-*.jar > app.log 2>&1 &
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then
              echo "Application ready for DAST!"
              break
            fi
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090
      - name: Verify Application Health
        run: curl -f http://localhost:8090/actuator/health
      - name: Run OWASP ZAP Baseline Scan
        run: |
          docker run --network="host" -v $(pwd):/zap/wrk/:rw \
            -t zaproxy/zap-stable zap-baseline.py \
            -t http://localhost:8090 \
            -g gen.conf \
            -r zap-baseline-report.html \
            -w zap-baseline-report.md \
            -J zap-baseline-report.json \
            -x zap-baseline-report.xml || echo "ZAP baseline scan completed"
        continue-on-error: true
      - name: Run OWASP ZAP Full Scan
        run: |
          docker run --network="host" -v $(pwd):/zap/wrk/:rw \
            -t zaproxy/zap-stable zap-full-scan.py \
            -t http://localhost:8090 \
            -c .zap/zap-config.yaml \
            -r zap-full-report.html \
            -w zap-full-report.md \
            -J zap-full-report.json \
            -x zap-full-report.xml \
            -z "-config api.addrs.addr.name=.* -config api.addrs.addr.regex=true" || echo "Full ZAP scan completed"
        continue-on-error: true
      - name: Upload DAST Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dast-zap-reports
          path: |
            zap-*.html
            zap-*.md
            zap-*.json
            zap-*.xml
          if-no-files-found: warn

# ════════════════════════════════════════════════════════════════════════
#  STAGE 7 — Deploy to AWS ECS/Fargate
# ════════════════════════════════════════════════════════════════════════

  # ── Deploy to Staging (develop / feature branches) — EC2 + Docker ──
  deploy-staging:
    runs-on: ubuntu-latest
    name: Deploy to Staging
    needs: [iast-otel, k6-performance, dast-zap, build-push, sonarqube]
    if: |
      !cancelled() &&
      needs.build-push.result == 'success' &&
      (github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/feature/'))
    environment:
      name: staging
      url: ${{ steps.get-url.outputs.service_url }}
    outputs:
      service_url: ${{ steps.get-url.outputs.service_url }}
      aws_configured: ${{ steps.check_aws.outputs.aws_configured }}
    permissions:
      packages: read
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Check AWS & EC2 Configuration
        id: check_aws
        run: |
          if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ] && [ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ] && [ -n "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "aws_configured=true" >> $GITHUB_OUTPUT
          else
            echo "aws_configured=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS Credentials
        if: steps.check_aws.outputs.aws_configured == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEPLOY_REGION }}

      - name: Get EC2 Public IP & AZ
        if: steps.check_aws.outputs.aws_configured == 'true'
        id: get-ip
        run: |
          read -r EC2_IP EC2_AZ <<< "$(aws ec2 describe-instances \
            --instance-ids ${{ env.EC2_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].[PublicIpAddress,Placement.AvailabilityZone]' \
            --output text)"
          echo "ec2_ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "ec2_az=$EC2_AZ" >> $GITHUB_OUTPUT
          echo "EC2 Public IP: $EC2_IP"
          echo "EC2 Availability Zone: $EC2_AZ"

      - name: Deploy Docker container to EC2
        if: steps.check_aws.outputs.aws_configured == 'true'
        run: |
          printf '%s' "${{ secrets.EC2_SSH_KEY }}" > deploy_key
          chmod 600 deploy_key
          ssh-keygen -y -f deploy_key > deploy_key.pub
          EC2_IP="${{ steps.get-ip.outputs.ec2_ip }}"
          EC2_AZ="${{ steps.get-ip.outputs.ec2_az }}"
          EC2_USER="${{ env.EC2_SSH_USER }}"

          echo "Attempting EC2 Instance Connect key injection (best-effort)..."
          aws ec2-instance-connect send-ssh-public-key \
            --instance-id ${{ env.EC2_INSTANCE_ID }} \
            --availability-zone "${EC2_AZ}" \
            --instance-os-user "${EC2_USER}" \
            --ssh-public-key file://deploy_key.pub \
            || echo "WARNING: EC2 Instance Connect key injection failed. SSH may still work if the key is already authorized on the instance. If SSH fails, ensure port 22 is open and IAM allows ec2-instance-connect:SendSSHPublicKey."

          ssh -o StrictHostKeyChecking=no -i deploy_key ${EC2_USER}@${EC2_IP} << EOF
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              sudo yum update -y && sudo yum install -y docker
              sudo systemctl enable docker
            fi
            sudo systemctl start docker

            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | sudo docker login ghcr.io -u "${{ github.actor }}" --password-stdin

            # Pull latest image
            sudo docker pull ${{ needs.build-push.outputs.image }}

            # Replace running container
            sudo docker stop ecogo 2>/dev/null || true
            sudo docker rm ecogo 2>/dev/null || true
            sudo docker run -d --name ecogo \
              --restart unless-stopped \
              --network host \
              -e SERVER_PORT=${{ env.DEPLOY_PORT }} \
              ${{ needs.build-push.outputs.image }}

            # Health check
            echo "Waiting for application to start..."
            for i in \$(seq 1 30); do
              if curl -s http://localhost:${{ env.DEPLOY_PORT }}/actuator/health > /dev/null 2>&1; then
                echo "Application is healthy!"
                break
              fi
              sleep 5
            done
          EOF

          rm -f deploy_key deploy_key.pub

      - name: Get deployment URL
        id: get-url
        if: steps.check_aws.outputs.aws_configured == 'true'
        run: |
          echo "service_url=http://${{ steps.get-ip.outputs.ec2_ip }}:${{ env.DEPLOY_PORT }}" >> $GITHUB_OUTPUT

      - name: AWS Not Configured Warning
        if: steps.check_aws.outputs.aws_configured != 'true'
        run: |
          echo "⚠️ Missing secrets for EC2 deployment."
          echo "Required: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, EC2_SSH_KEY"

      - name: Staging Deploy Summary
        if: always()
        run: |
          echo "## Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ needs.build-push.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.get-url.outputs.service_url }}" ]; then
            echo "- **URL:** ${{ steps.get-url.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          fi

  # ── Deploy to Production (main branch only) — EC2 + Docker ────────
  deploy-production:
    runs-on: ubuntu-latest
    name: Deploy to AWS EC2 (docker)
    needs: [iast-otel, k6-performance, dast-zap, build-push, sonarqube]
    if: |
      !cancelled() &&
      needs.build-push.result == 'success' &&
      github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ steps.get-url.outputs.service_url }}
    outputs:
      service_url: ${{ steps.get-url.outputs.service_url }}
      aws_configured: ${{ steps.check_aws.outputs.aws_configured }}
    permissions:
      packages: read
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Check AWS & EC2 Configuration
        id: check_aws
        run: |
          if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ] && [ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ] && [ -n "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "aws_configured=true" >> $GITHUB_OUTPUT
          else
            echo "aws_configured=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS Credentials
        if: steps.check_aws.outputs.aws_configured == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEPLOY_REGION }}

      - name: Get EC2 Public IP & AZ
        if: steps.check_aws.outputs.aws_configured == 'true'
        id: get-ip
        run: |
          read -r EC2_IP EC2_AZ <<< "$(aws ec2 describe-instances \
            --instance-ids ${{ env.EC2_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].[PublicIpAddress,Placement.AvailabilityZone]' \
            --output text)"
          echo "ec2_ip=$EC2_IP" >> $GITHUB_OUTPUT
          echo "ec2_az=$EC2_AZ" >> $GITHUB_OUTPUT
          echo "EC2 Public IP: $EC2_IP"
          echo "EC2 Availability Zone: $EC2_AZ"

      - name: Deploy Docker container to EC2
        if: steps.check_aws.outputs.aws_configured == 'true'
        run: |
          printf '%s' "${{ secrets.EC2_SSH_KEY }}" > deploy_key
          chmod 600 deploy_key
          ssh-keygen -y -f deploy_key > deploy_key.pub
          EC2_IP="${{ steps.get-ip.outputs.ec2_ip }}"
          EC2_AZ="${{ steps.get-ip.outputs.ec2_az }}"
          EC2_USER="${{ env.EC2_SSH_USER }}"

          echo "Attempting EC2 Instance Connect key injection (best-effort)..."
          aws ec2-instance-connect send-ssh-public-key \
            --instance-id ${{ env.EC2_INSTANCE_ID }} \
            --availability-zone "${EC2_AZ}" \
            --instance-os-user "${EC2_USER}" \
            --ssh-public-key file://deploy_key.pub \
            || echo "WARNING: EC2 Instance Connect key injection failed. SSH may still work if the key is already authorized on the instance. If SSH fails, ensure port 22 is open and IAM allows ec2-instance-connect:SendSSHPublicKey."

          ssh -o StrictHostKeyChecking=no -i deploy_key ${EC2_USER}@${EC2_IP} << EOF
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              sudo yum update -y && sudo yum install -y docker
              sudo systemctl enable docker
            fi
            sudo systemctl start docker

            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | sudo docker login ghcr.io -u "${{ github.actor }}" --password-stdin

            # Pull latest image
            sudo docker pull ${{ needs.build-push.outputs.image }}

            # Replace running container
            sudo docker stop ecogo 2>/dev/null || true
            sudo docker rm ecogo 2>/dev/null || true
            sudo docker run -d --name ecogo \
              --restart unless-stopped \
              --network host \
              -e SERVER_PORT=${{ env.DEPLOY_PORT }} \
              ${{ needs.build-push.outputs.image }}

            # Health check
            echo "Waiting for application to start..."
            for i in \$(seq 1 30); do
              if curl -s http://localhost:${{ env.DEPLOY_PORT }}/actuator/health > /dev/null 2>&1; then
                echo "Application is healthy!"
                break
              fi
              sleep 5
            done
          EOF

          rm -f deploy_key deploy_key.pub

      - name: Get deployment URL
        id: get-url
        if: steps.check_aws.outputs.aws_configured == 'true'
        run: |
          echo "service_url=http://${{ steps.get-ip.outputs.ec2_ip }}:${{ env.DEPLOY_PORT }}" >> $GITHUB_OUTPUT

      - name: AWS Not Configured Warning
        if: steps.check_aws.outputs.aws_configured != 'true'
        run: |
          echo "⚠️ Missing secrets for EC2 deployment."
          echo "Required: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, EC2_SSH_KEY"

      - name: Production Deploy Summary
        if: always()
        run: |
          echo "## Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ needs.build-push.outputs.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.get-url.outputs.service_url }}" ]; then
            echo "- **URL:** ${{ steps.get-url.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          fi

# ════════════════════════════════════════════════════════════════════════
#  STAGE 8 — Post-Deploy Tests (Staging)
# ════════════════════════════════════════════════════════════════════════

  integration-tests-staging:
    runs-on: ubuntu-latest
    name: Integration Tests - Staging
    needs: deploy-staging
    if: |
      !cancelled() &&
      (github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/feature/'))
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Run Integration Tests
        run: mvn clean verify -Dcheckstyle.skip=true -Dspotbugs.skip=true
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo

  smoke-tests-staging:
    runs-on: ubuntu-latest
    name: Smoke Tests - Staging
    needs: deploy-staging
    if: |
      !cancelled() &&
      (github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/feature/'))
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4

      - name: Determine deployment target URL
        id: check_deployment
        run: |
          DEPLOY_URL="${{ needs.deploy-staging.outputs.service_url }}"
          if [ -n "$DEPLOY_URL" ]; then
            echo "has_deployment=true" >> $GITHUB_OUTPUT
            echo "target_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
            echo "✅ Using AWS deployment URL from deploy step: $DEPLOY_URL"
          elif [ -n "${{ secrets.STAGING_URL }}" ]; then
            echo "has_deployment=true" >> $GITHUB_OUTPUT
            echo "target_url=${{ secrets.STAGING_URL }}" >> $GITHUB_OUTPUT
            echo "✅ Using STAGING_URL secret"
          else
            echo "has_deployment=false" >> $GITHUB_OUTPUT
            echo "target_url=http://localhost:8090" >> $GITHUB_OUTPUT
            echo "⚠️ No AWS deployment detected, falling back to localhost"
          fi

      - name: Set up JDK 17
        if: steps.check_deployment.outputs.has_deployment != 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Download Build Artifacts
        if: steps.check_deployment.outputs.has_deployment != 'true'
        uses: actions/download-artifact@v4
        with:
          name: jacoco-coverage-report
          path: coverage-report/
        continue-on-error: true

      - name: Build and Start Local Application (fallback)
        if: steps.check_deployment.outputs.has_deployment != 'true'
        run: |
          mvn clean package -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true
          nohup java -jar target/EcoGo-*.jar > app.log 2>&1 &
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then
              echo "Application is ready!"
              break
            fi
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090

      - name: Wait for AWS Deployment to stabilize
        if: steps.check_deployment.outputs.has_deployment == 'true'
        run: |
          echo "Waiting for AWS deployment to stabilize..."
          sleep 30
          echo "Testing deployment at ${{ steps.check_deployment.outputs.target_url }}"
          curl -sf ${{ steps.check_deployment.outputs.target_url }}/actuator/health || echo "Health endpoint not yet ready"

      - name: Run Smoke Tests
        run: |
          echo "Running smoke tests against: ${{ steps.check_deployment.outputs.target_url }}"
          chmod +x .github/scripts/smoke-tests.sh
          ./.github/scripts/smoke-tests.sh ${{ steps.check_deployment.outputs.target_url }}
        continue-on-error: true

      - name: Test Critical API Endpoints
        run: |
          TARGET="${{ steps.check_deployment.outputs.target_url }}"
          echo "Testing endpoints at: $TARGET"
          curl -f ${TARGET}/actuator/health || echo "Health check completed"
          curl -sf ${TARGET}/actuator/info || echo "Info endpoint completed"
        continue-on-error: true

  performance-tests-staging:
    runs-on: ubuntu-latest
    name: Performance Tests - Staging
    needs: smoke-tests-staging
    if: |
      !cancelled() &&
      (github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/feature/'))
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Build and Start Application
        run: |
          mvn clean package -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true
          nohup java -jar target/EcoGo-*.jar > app.log 2>&1 &
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then
              echo "Application ready!"
              break
            fi
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090
      - name: Run JMeter Tests
        run: |
          docker run --network="host" \
            -v $(pwd)/performance-tests:/tests \
            justb4/jmeter \
            -n -t /tests/load-test.jmx \
            -l /tests/results.jtl \
            -e -o /tests/report || echo "JMeter tests completed"
        continue-on-error: true
      - name: Upload Performance Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jmeter-report-staging
          path: performance-tests/report/
          if-no-files-found: warn

  dast-staging:
    runs-on: ubuntu-latest
    name: DAST - Staging
    needs: performance-tests-staging
    if: |
      !cancelled() &&
      (github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/feature/'))
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Build and Start Application
        run: |
          mvn clean package -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true
          nohup java -jar target/EcoGo-*.jar > app.log 2>&1 &
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then echo "Ready!"; break; fi
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090
      - name: Run OWASP ZAP Baseline Scan
        run: |
          docker run --network="host" -v $(pwd):/zap/wrk/:rw \
            -t zaproxy/zap-stable zap-baseline.py \
            -t http://localhost:8090 \
            -g gen.conf \
            -r testreport.html -w testreport.md \
            -J zap-report.json -x zap-report.xml || echo "ZAP scan completed"
        continue-on-error: true
      - name: Run Full ZAP Scan
        run: |
          docker run --network="host" -v $(pwd):/zap/wrk/:rw \
            -t zaproxy/zap-stable zap-full-scan.py \
            -t http://localhost:8090 \
            -c .zap/zap-config.yaml \
            -r zap-report.html -w zap-report.md \
            -J zap-report-full.json -x zap-report-full.xml \
            -z "-config api.addrs.addr.name=.* -config api.addrs.addr.regex=true" || echo "Full ZAP scan completed"
        continue-on-error: true
      - name: Upload DAST Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-report-staging
          path: |
            zap-report*.html
            zap-report*.md
            zap-report*.json
            zap-report*.xml
            testreport.*
          if-no-files-found: ignore

  # ── PRESERVED: Monitoring Setup - Staging ──────────────────────────
  monitoring-setup-staging:
    runs-on: ubuntu-latest
    name: Setup Monitoring Stack - Staging
    needs: [dast-staging]
    if: always() && (github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/heads/feature/'))
    steps:
      - uses: actions/checkout@v4

      - name: Validate Prometheus Configuration
        run: |
          echo "Validating monitoring configuration files..."
          if [ -f monitoring/prometheus.yml ]; then
            echo "✅ prometheus.yml found"
            docker run --rm -v $(pwd)/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml \
              prom/prometheus:latest promtool check config /etc/prometheus/prometheus.yml || echo "Config check completed"
          fi

      - name: Deploy Prometheus
        run: |
          docker run -d --name prometheus \
            -v $(pwd)/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml \
            -p 9090:9090 \
            prom/prometheus:latest
          sleep 5
          echo "Prometheus status:"
          curl -s http://localhost:9090/-/healthy && echo " ✅ Prometheus is healthy" || echo " ⚠️ Prometheus not ready"
        continue-on-error: true

      - name: Deploy Grafana
        run: |
          docker run -d --name grafana \
            -e GF_SECURITY_ADMIN_PASSWORD=admin \
            -p 3000:3000 \
            grafana/grafana:latest
          sleep 10
          echo "Grafana status:"
          curl -s http://localhost:3000/api/health && echo " ✅ Grafana is healthy" || echo " ⚠️ Grafana not ready"
        continue-on-error: true

      - name: Configure Grafana Data Source
        run: |
          curl -X POST http://localhost:3000/api/datasources \
            -H "Content-Type: application/json" \
            -d '{"name":"Prometheus","type":"prometheus","url":"http://prometheus:9090","access":"proxy","isDefault":true}' \
            -u admin:admin && echo " ✅ Grafana data source configured" || echo " ⚠️ Data source config skipped"
        continue-on-error: true

      - name: Verify Monitoring Stack
        if: always()
        run: |
          echo "## Monitoring Stack Validation" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          PROM=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9090/-/healthy 2>/dev/null || echo "000")
          GRAF=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health 2>/dev/null || echo "000")
          echo "| Prometheus | HTTP ${PROM} |" >> $GITHUB_STEP_SUMMARY
          echo "| Grafana | HTTP ${GRAF} |" >> $GITHUB_STEP_SUMMARY

# ════════════════════════════════════════════════════════════════════════
#  STAGE 9 — Post-Deploy Tests (Production)
# ════════════════════════════════════════════════════════════════════════

  integration-tests-production:
    runs-on: ubuntu-latest
    name: Integration Tests - Production
    needs: deploy-production
    if: |
      !cancelled() &&
      github.ref == 'refs/heads/main'
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Run Integration Tests
        run: mvn clean verify -Dcheckstyle.skip=true -Dspotbugs.skip=true
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo

  smoke-tests-production:
    runs-on: ubuntu-latest
    name: Smoke Tests - Production
    needs: [deploy-production, integration-tests-production]
    if: |
      !cancelled() &&
      github.ref == 'refs/heads/main'
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4

      - name: Determine deployment target URL
        id: check_deployment
        run: |
          DEPLOY_URL="${{ needs.deploy-production.outputs.service_url }}"
          if [ -n "$DEPLOY_URL" ]; then
            echo "has_deployment=true" >> $GITHUB_OUTPUT
            echo "target_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
            echo "✅ Using AWS deployment URL from deploy step: $DEPLOY_URL"
          elif [ -n "${{ secrets.PRODUCTION_URL }}" ]; then
            echo "has_deployment=true" >> $GITHUB_OUTPUT
            echo "target_url=${{ secrets.PRODUCTION_URL }}" >> $GITHUB_OUTPUT
            echo "✅ Using PRODUCTION_URL secret"
          else
            echo "has_deployment=false" >> $GITHUB_OUTPUT
            echo "target_url=http://localhost:8090" >> $GITHUB_OUTPUT
            echo "⚠️ No AWS deployment detected, falling back to localhost"
          fi

      - name: Set up JDK 17
        if: steps.check_deployment.outputs.has_deployment != 'true'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build and Start Local Application (fallback)
        if: steps.check_deployment.outputs.has_deployment != 'true'
        run: |
          mvn clean package -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true
          nohup java -jar target/EcoGo-*.jar > app.log 2>&1 &
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then
              echo "Application is ready!"
              break
            fi
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090

      - name: Wait for Deployment (if real)
        if: steps.check_deployment.outputs.has_deployment == 'true'
        run: sleep 30

      - name: Run Smoke Tests
        run: |
          chmod +x .github/scripts/smoke-tests.sh
          ./.github/scripts/smoke-tests.sh ${{ steps.check_deployment.outputs.target_url }}
        continue-on-error: true

  performance-tests-production:
    runs-on: ubuntu-latest
    name: Performance Tests - Production
    needs: smoke-tests-production
    if: |
      !cancelled() &&
      github.ref == 'refs/heads/main'
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Build and Start Application
        run: |
          mvn clean package -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true
          nohup java -jar target/EcoGo-*.jar > app.log 2>&1 &
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then
              echo "Application ready!"
              break
            fi
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090
      - name: Run JMeter Tests
        run: |
          docker run --network="host" \
            -v $(pwd)/performance-tests:/tests \
            justb4/jmeter \
            -n -t /tests/load-test.jmx \
            -l /tests/results.jtl \
            -e -o /tests/report || echo "JMeter tests completed"
        continue-on-error: true
      - name: Upload Performance Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jmeter-report-production
          path: performance-tests/report/
          if-no-files-found: warn

  dast-production:
    runs-on: ubuntu-latest
    name: DAST with OWASP ZAP - Production
    needs: performance-tests-production
    if: |
      !cancelled() &&
      github.ref == 'refs/heads/main'
    services:
      mongodb:
        image: mongo:latest
        options: >-
          --health-cmd mongosh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 27017:27017
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Build and Start Application
        run: |
          mvn clean package -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true
          nohup java -jar target/EcoGo-*.jar > app.log 2>&1 &
          for i in {1..30}; do
            if curl -s http://localhost:8090/actuator/health > /dev/null 2>&1; then echo "Ready!"; break; fi
            sleep 3
          done
        env:
          SPRING_DATA_MONGODB_URI: mongodb://localhost:27017/ecogo
          SERVER_PORT: 8090
      - name: Verify Application Health
        run: curl -v http://localhost:8090/actuator/health
      - name: Run OWASP ZAP Baseline Scan
        run: |
          docker run --network="host" -v $(pwd):/zap/wrk/:rw \
            -t zaproxy/zap-stable zap-baseline.py \
            -t http://localhost:8090 \
            -g gen.conf \
            -r testreport.html -w testreport.md \
            -J zap-report.json -x zap-report.xml || echo "ZAP scan completed"
        continue-on-error: true
      - name: Run Full ZAP Scan
        run: |
          docker run --network="host" -v $(pwd):/zap/wrk/:rw \
            -t zaproxy/zap-stable zap-full-scan.py \
            -t http://localhost:8090 \
            -c .zap/zap-config.yaml \
            -r zap-report.html -w zap-report.md \
            -J zap-report-full.json -x zap-report-full.xml \
            -z "-config api.addrs.addr.name=.* -config api.addrs.addr.regex=true" || echo "Full ZAP completed"
        continue-on-error: true
      - name: Upload DAST Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dast-report-production
          path: |
            zap-report*.html
            zap-report*.md
            zap-report*.json
            zap-report*.xml
            testreport.*
          if-no-files-found: ignore

  # ── PRESERVED: Monitoring Setup - Production ───────────────────────
  monitoring-setup-production:
    runs-on: ubuntu-latest
    name: Setup Monitoring Stack - Production
    needs: dast-production
    if: |
      always() &&
      github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Validate Prometheus Configuration
        run: |
          echo "Validating monitoring configuration files..."
          if [ -f monitoring/prometheus.yml ]; then
            echo "✅ prometheus.yml found"
            docker run --rm -v $(pwd)/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml \
              prom/prometheus:latest promtool check config /etc/prometheus/prometheus.yml || echo "Config check completed"
          fi

      - name: Deploy Prometheus
        run: |
          docker run -d --name prometheus \
            -v $(pwd)/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml \
            -p 9090:9090 \
            prom/prometheus:latest
          sleep 5
          curl -s http://localhost:9090/-/healthy && echo " ✅ Prometheus is healthy" || echo " ⚠️ Prometheus not ready"
        continue-on-error: true

      - name: Deploy Grafana
        run: |
          docker run -d --name grafana \
            -e GF_SECURITY_ADMIN_PASSWORD=admin \
            -p 3000:3000 \
            grafana/grafana:latest
          sleep 10
          curl -s http://localhost:3000/api/health && echo " ✅ Grafana is healthy" || echo " ⚠️ Grafana not ready"
        continue-on-error: true

      - name: Configure Grafana Data Source
        run: |
          curl -X POST http://localhost:3000/api/datasources \
            -H "Content-Type: application/json" \
            -d '{"name":"Prometheus","type":"prometheus","url":"http://prometheus:9090","access":"proxy","isDefault":true}' \
            -u admin:admin && echo " ✅ Data source configured" || echo " ⚠️ Config skipped"
        continue-on-error: true

      - name: Verify Monitoring Stack
        if: always()
        run: |
          echo "## Production Monitoring Validation" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          PROM=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9090/-/healthy 2>/dev/null || echo "000")
          GRAF=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health 2>/dev/null || echo "000")
          echo "| Prometheus | HTTP ${PROM} |" >> $GITHUB_STEP_SUMMARY
          echo "| Grafana | HTTP ${GRAF} |" >> $GITHUB_STEP_SUMMARY

# ════════════════════════════════════════════════════════════════════════
#  Pipeline Status Report
# ════════════════════════════════════════════════════════════════════════

  pipeline-status:
    runs-on: ubuntu-latest
    name: Pipeline Status
    needs:
      - detect-folders
      - unit-tests-java
      - lint
      - sast-codeql-java
      - sast-legacy
      - sca-trivy-fs
      - ci-metrics
      - sonarqube
      - integration-tests
      - build-push
      - container-scan
      - deploy-staging
      - deploy-production
    if: always()
    steps:
      - name: Pipeline Summary
        run: |
          echo "## EcoGo CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Job | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1 | Detect Folders | \`${{ needs.detect-folders.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | Unit Tests (Java) | \`${{ needs.unit-tests-java.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | Lint & Quality | \`${{ needs.lint.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | SAST (CodeQL) | \`${{ needs.sast-codeql-java.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | SAST (SpotBugs+OWASP) | \`${{ needs.sast-legacy.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 2 | SCA (Trivy FS) | \`${{ needs.sca-trivy-fs.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | CI Metrics | \`${{ needs.ci-metrics.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 3 | SonarQube | \`${{ needs.sonarqube.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 4 | Integration Tests | \`${{ needs.integration-tests.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 5 | Build & Push | \`${{ needs.build-push.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 5 | Container Scan | \`${{ needs.container-scan.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 7 | Deploy Staging | \`${{ needs.deploy-staging.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| 7 | Deploy Production | \`${{ needs.deploy-production.result }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }} | **Commit:** \`${{ github.sha }}\` | **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
